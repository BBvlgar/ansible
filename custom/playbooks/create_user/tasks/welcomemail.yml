---
- hosts: hs2

  tasks:
    - set_fact:
        user: "{{ hostvars.get('localhost').get('user') }}"

    - set_fact:
        mail_template: "welcome_mail.j2"

    - debug:
        msg: "System {{ mail_template }} has uuid {{ mail_template }}"

    - set_fact:
        mail_template: "welcome_mail_sopra.j2"
      when: "{{ user.registration.contract.employerId }} == 12700"

    - debug:
        msg: "System {{ mail_template }} has uuid {{ mail_template }}"

    - set_fact:
        mail_template: "welcome_mail_extern.j2"
      when: "{{ user.registration.contract.employerId }} == 11402"

    - debug:
        msg: "System {{ mail_template }} has uuid {{ mail_template }}"

    - set_fact:
        mail_template: "welcome_mail_extern.j2"
      when: "{{ user.registration.contract.employerId }} == 11403"

    - debug:
        msg: "System {{ mail_template }} has uuid {{ mail_template }}"

    - name: Copy welcome mail to server
      template:
        src: "../templates/{{ mail_template }}"
        dest: "/tmp/{{ user.registration.user.mail }}.welcome"

    - name: Send welcome mail
      shell: cat /tmp/{{ user.registration.user.mail }}.welcome | mail -s "Herzlich Willkommen bei der it-e!" {{ user.registration.user.mail }}
      when: "{{ user.registration.contract.employerId }} != 11400 and {{ user.registration.contract.employerId }} != 11401"

    - name: Make sure welcome mail is deleted
      file:
        path: "/tmp/{{ user.registration.user.mail }}.welcome"
        state: absent

    - uri:
        url: "{{ ticket_system }}/rest/api/2/issue/{{ hostvars.get('localhost').get('ticket_number') }}/comment"
        user: "{{ ticket_user }}"
        password: "{{ ticket_password }}"
        method: "POST"
        force_basic_auth: yes
        status_code: [201]
        body_format: "json"
        body:
          body: "Welcome Mail versendet"
