---

dmarc_elc_version: "7.16.3"

applications:
  skillmatrix_stack:
    skillmatrix-service:
      name: skillmatrix-service
      image: "{{ docker_registry }}iteconomics/mindmap-service:latest"
      restartPolicy: always
      environment:
        POSTGRESQL_URL:         "{{ skillmatrixservice.POSTGRESQL_URL }}"
        POSTGRESQL_USER:        "{{ skillmatrixservice.POSTGRESQL_USER }}"
        POSTGRESQL_PASSWORD:    "{{ skillmatrixservice.POSTGRESQL_PASSWORD }}"
        STATIC_CONTENT_PATH:    "/usr/share/nginx/html"
        LDAP_URI:               "ldaps://ldap01.auth.it-economics.de:22636"
        LDAP_BASE:              "dc=it-economics,dc=de"
        LDAP_PEOPLE:            "ou=people"
        LDAP_ADMIN_GROUP:       "cn=prm_social_onepager-administrators,ou=groups,dc=it-economics,dc=de"
        ATTRIBUTE_MAIL:         "mail"
        ATTRIBUTE_CN:           "cn"
        ATTRIBUTE_UID:          "uid"
        ATTRIBUTE_OBJECT_CLASS: "objectClass"
        ATTRIBUTE_MEMBER_OF:    "memberOf"
        ATTRIBUTE_LOCATION:     "l"
        ATTRIBUTE_DESCRIPTION:  "description"
        ATTRIBUTE_JPEG_PHOTO:   "jpegPhoto"
        CLASS_CATEGORY_PERSON:  "person"
      volumes:
        - "{{ docker_home }}/skillmatrix/html/:/usr/share/nginx/html"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.skillmatrix-service.loadbalancer.server.port: '8085'"
        - "traefik.http.routers.skillmatrix-service_http.rule: 'Host(`skillmatrix-service.it-economics.de`)'"
        - "traefik.http.routers.skillmatrix-service_http.entrypoints: 'web'"
        - "traefik.http.routers.skillmatrix-service_http.middlewares: 'forcehttps@file,skillmatrix'"
        - "traefik.http.routers.skillmatrix-service.middlewares: 'skillmatrix'"
        - "traefik.http.routers.skillmatrix-service.rule: 'Host(`skillmatrix-service.it-economics.de`)'"
        - "traefik.http.routers.skillmatrix-service.entrypoints: 'websecure'"
        - "traefik.http.routers.skillmatrix-service.tls: 'true'"
        - "traefik.http.routers.skillmatrix-service.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.skillmatrix-service.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.skillmatrix-service.tls.domains[0].sans: '*.it-economics.de'"
        # Skillmatrix Middleware for allowing CORS (Cross-Origin Resource Sharing)
        - "traefik.http.middlewares.skillmatrix.headers.accesscontrolallowmethods: 'GET,POST,OPTIONS'"
        - "traefik.http.middlewares.skillmatrix.headers.accessControlAllowCredentials: 'true'"
        - "traefik.http.middlewares.skillmatrix.headers.accesscontrolmaxage: '180'"
        - "traefik.http.middlewares.skillmatrix.headers.addvaryheader: 'true'"
        - "traefik.http.middlewares.skillmatrix.headers.accessControlAllowOriginList: 'https://skillmatrix-service.it-economics.de,https://skillmatrix.it-economics.de'"
        - "traefik.http.middlewares.skillmatrix.headers.accessControlAllowHeaders: '*'"
      networks:
        - "backbone"
        - "database"

    skillmatrix-gui:
      name: skillmatrix-gui
      image: "{{ docker_registry }}iteconomics/d3-skills-mindmap:23"
      volumes:
        - "{{ docker_home }}/skillmatrix/html/:/usr/share/nginx/html"
      restartPolicy: always
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.skillmatrix.loadbalancer.server.port: '8080'"
        - "traefik.http.routers.skillmatrix_http.rule: 'Host(`skillmatrix.it-economics.de`)'"
        - "traefik.http.routers.skillmatrix_http.entrypoints: 'web'"
        - "traefik.http.routers.skillmatrix_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.skillmatrix.middlewares: 'skillmatrix'"
        - "traefik.http.routers.skillmatrix.rule: 'Host(`skillmatrix.it-economics.de`)'"
        - "traefik.http.routers.skillmatrix.entrypoints: 'websecure'"
        - "traefik.http.routers.skillmatrix.tls: 'true'"
        - "traefik.http.routers.skillmatrix.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.skillmatrix.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.skillmatrix.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        VUE_APP_BACKEND_URL: "https://skillmatrix-service.it-economics.de"
      networks:
        - "backbone"
        - "database"

  appstore_stack:
    appstore:
      name: appstore
      image: "{{ docker_registry }}iteconomics/apache:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/appstore/web/certs:/certs"
        - "{{ docker_home }}/appstore/web/config:/etc/apache2/sites-enabled"
        - "{{ docker_home }}/appstore/data:/var/www/html"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.appstore.loadbalancer.server.port: '80'"
        - "traefik.http.routers.appstore_http.rule: 'Host(`appstore.it-economics.de`)'"
        - "traefik.http.routers.appstore_http.entrypoints: 'web'"
        - "traefik.http.routers.appstore_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.appstore.rule: 'Host(`appstore.it-economics.de`)'"
        - "traefik.http.routers.appstore.entrypoints: 'websecure'"
        - "traefik.http.routers.appstore.tls: 'true'"
        - "traefik.http.routers.appstore.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.appstore.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.appstore.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        MODS: "ssl ldap authnz_ldap php7 rewrite headers"
      networks:
        - "backbone"

    appstore_ssh:
      name: appstore_ssh
      image: "{{ docker_registry }}devopsansiblede/worksuite:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/appstore/ssh/authorized_keys:/root/.ssh/authorized_keys"
        - "{{ docker_home }}/appstore/data:/var/www/html"
      labels:
        - "traefik.enable: false"
      ports:
      - "50022:22"
      networks:
        - "backbone"

  atlassian-quote_stack:
    atlassian-quote:
      name: atlassian-quote
      image: "{{ docker_registry }}iteconomics/atlassian-quote:latest"
      restartPolicy: always
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.atlassian-quote.loadbalancer.server.port: '80'"
        - "traefik.http.routers.atlassian-quote_http.rule: 'Host(`atlassian-quote.it-economics.de`)'"
        - "traefik.http.routers.atlassian-quote_http.entrypoints: 'web'"
        - "traefik.http.routers.atlassian-quote_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.atlassian-quote.rule: 'Host(`atlassian-quote.it-economics.de`)'"
        - "traefik.http.routers.atlassian-quote.entrypoints: 'websecure'"
        - "traefik.http.routers.atlassian-quote.tls: 'true'"
        - "traefik.http.routers.atlassian-quote.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.atlassian-quote.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.atlassian-quote.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        OpenID_ClientSecret: "{{ atlassianquote.OpenID_ClientSecret }}"
        OpenID_ClientID: "{{ atlassianquote.OpenID_ClientID }}"
        OpenID_MetaDataURL: "{{ atlassianquote.OpenID_MetaDataURL }}"
        OpenID_RedirectURL: "{{ atlassianquote.OpenID_RedirectURL }}"
        OpenID_Mailpost: "{{ atlassianquote.OpenID_Mailpost }}"
      networks:
        - "backbone"
        - "database"

  teamsurvey-dashboard_stack:
    teamsurvey-dashboard:
      name: teamsurvey-dashboard
      image: "{{ docker_registry }}iteconomics/teamsurvey-dashboard:latest"
      restartPolicy: always
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.teamsurvey-dashboard.loadbalancer.server.port: '80'"
        - "traefik.http.routers.teamsurvey-dashboard_http.rule: 'Host(`teamsurvey.it-economics.de`)'"
        - "traefik.http.routers.teamsurvey-dashboard_http.entrypoints: 'web'"
        - "traefik.http.routers.teamsurvey-dashboard_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.teamsurvey-dashboard.rule: 'Host(`teamsurvey.it-economics.de`)'"
        - "traefik.http.routers.teamsurvey-dashboard.entrypoints: 'websecure'"
        - "traefik.http.routers.teamsurvey-dashboard.tls: 'true'"
        - "traefik.http.routers.teamsurvey-dashboard.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.teamsurvey-dashboard.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.teamsurvey-dashboard.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        GRAPHQL_ENDPOINT: "https://teamsurvey-api.it-economics.de/graphql"
      networks:
        - "backbone"

  teamsurvey-dashboard-testing_stack:
    teamsurvey-dashboard-testing:
      name: teamsurvey-dashboard-testing
      image: "{{ docker_registry }}iteconomics/teamsurvey-dashboard:testing"
      restartPolicy: always
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.teamsurvey-dashboard-testing.loadbalancer.server.port: '80'"
        - "traefik.http.routers.teamsurvey-dashboard-testing_http.rule: 'Host(`teamsurvey-test.it-economics.de`)'"
        - "traefik.http.routers.teamsurvey-dashboard-testing_http.entrypoints: 'web'"
        - "traefik.http.routers.teamsurvey-dashboard-testing_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.rule: 'Host(`teamsurvey-test.it-economics.de`)'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.entrypoints: 'websecure'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.tls: 'true'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.teamsurvey-dashboard-testing.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        GRAPHQL_ENDPOINT: "https://teamsurvey-api-testing.it-economics.de/graphql"
      networks:
        - "backbone"

  vcard_stack:
    vcard:
      name: vcard
      image: "{{ docker_registry }}iteconomics/apache:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/vcard/web/proxy.conf:/etc/apache2/sites-enabled/000-default.conf:ro"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.vcard.loadbalancer.server.port: '80'"
        - "traefik.http.routers.vcard_http.rule: 'Host(`vcard.it-economics.de`)'"
        - "traefik.http.routers.vcard_http.entrypoints: 'web'"
        - "traefik.http.routers.vcard_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.vcard.rule: 'Host(`vcard.it-economics.de`)'"
        - "traefik.http.routers.vcard.entrypoints: 'websecure'"
        - "traefik.http.routers.vcard.tls: 'true'"
        - "traefik.http.routers.vcard.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.vcard.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.vcard.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        MODS: "proxy proxy_http auth_basic authnz_ldap authz_core rewrite headers"
      networks:
        - "backbone"
        - "database"

    vcardserver:
      name: vcardserver
      image: "{{ docker_registry }}tomsquest/docker-radicale:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/vcard/docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh"
        - "{{ docker_home }}/vcard/config:/config"
        - "{{ docker_home }}/vcard/data:/data"
      labels:
        - "traefik.enable: false"
      networks:
        - "backbone"

    vcardsync:
      name: vcardsync
      image: "{{ docker_registry }}iteconomics/contactsync_ldap_exporter:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/vcard/data:/data"
      labels:
        - "traefik.enable: false"
      environment:
        ITE_CONTACT_DIR: '/data/collections/collection-root/'
        ITE.EXPORTCONTACTDIR: '/data/collections/collection-root/'
        LDAP_PASSWORD: "{{ ldap_directory_pass }}"
        LDAP_URL: "{{ ldap_url }}"
        LDAP_USERNAME: "{{ ldap_directory_user }}"
        network_mode: proxy

  surveyappproxy_stack:
    surveyappproxy:
      name: surveyappproxy
      image: "{{ docker_registry }}library/nginx:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/teamsurveyrest.it-economics.de/nginx.conf:/etc/nginx/nginx.conf"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.teamsurveyrest.loadbalancer.server.port: '80'"
        - "traefik.http.routers.teamsurveyrest_http.rule: 'Host(`teamsurveyrest.it-economics.de`)'"
        - "traefik.http.routers.teamsurveyrest_http.entrypoints: 'web'"
        - "traefik.http.routers.teamsurveyrest_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.teamsurveyrest.rule: 'Host(`teamsurveyrest.it-economics.de`)'"
        - "traefik.http.routers.teamsurveyrest.entrypoints: 'websecure'"
        - "traefik.http.routers.teamsurveyrest.tls: 'true'"
        - "traefik.http.routers.teamsurveyrest.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.teamsurveyrest.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.teamsurveyrest.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        MODS: "ssl ldap authnz_ldap php7 rewrite headers"
      networks:
        - "backbone"

  share_stack:
    share:
      name: share
      image: "{{ docker_registry }}devopsansiblede/nextcloud:latest"
      restartPolicy: always
      environment: 
        NC_APPS: "activity calendar cloud_federation_api contacts dav federatedfilesharing federation files files_accesscontrol files_external files_pdfviewer files_rightclick files_sharing files_trashbin files_versions files_videoplayer firstrunwizard groupfolders groupquota logreader lookup_server_connector nextcloud_announcements notifications oauth2 password_policy privacy provisioning_api serverinfo settings sharebymail text theming twofactor_backupcodes twofactor_email twofactor_totp twofactor_u2f updatenotification user_ldap viewer"
      volumes:
        - "{{ docker_home }}/share/data/apps:/var/www/html/apps"
        - "{{ docker_home }}/share/data/config:/var/www/html/config"
        - "{{ docker_home }}/share/data/data:/var/www/html/data"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.share.loadbalancer.server.port: '80'"
        - "traefik.http.routers.share_http.rule: 'Host(`share.it-economics.de`)'"
        - "traefik.http.routers.share_http.entrypoints: 'web'"
        - "traefik.http.routers.share_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.share.rule: 'Host(`share.it-economics.de`)'"
        - "traefik.http.routers.share.entrypoints: 'websecure'"
        - "traefik.http.routers.share.tls: 'true'"
        - "traefik.http.routers.share.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.share.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.share.tls.domains[0].sans: '*.it-economics.de'"
      networks:
        - "backbone"
        - "database"


  share-secrets_stack:
    share-secrets:
      name: share-secrets
      image: "{{ docker_registry }}iteconomics/apache:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/share-secrets/apache/apache.j2:/templates/apache.j2"
        - "{{ docker_home }}/share-secrets/html:/var/www/html/public"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.secrets.loadbalancer.server.port: '80'"
        - "traefik.http.routers.secrets_http.rule: 'Host(`secrets.it-economics.de`)'"
        - "traefik.http.routers.secrets_http.entrypoints: 'web'"
        - "traefik.http.routers.secrets_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.secrets.rule: 'Host(`secrets.it-economics.de`)'"
        - "traefik.http.routers.secrets.entrypoints: 'websecure'"
        - "traefik.http.routers.secrets.tls: 'true'"
        - "traefik.http.routers.secrets.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.secrets.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.secrets.tls.domains[0].sans: '*.it-economics.de'"
      networks:
        - "backbone"
      environment:
        APACHE_PUBLIC_DIR: '/var/www/html/public'

  roominfo-service_stack:
    roominfo-service:
      name: roominfo-service
      image: "{{ docker_registry }}iteconomics/icsviewer:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/roominfo-service/config/.env:/var/www/html/.env"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.roominfo-service.loadbalancer.server.port: '80'"
        - "traefik.http.routers.roominfo-service_http.rule: 'Host(`roominfo-service.it-economics.de`)'"
        - "traefik.http.routers.roominfo-service_http.entrypoints: 'web'"
        - "traefik.http.routers.roominfo-service_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.roominfo-service.rule: 'Host(`roominfo-service.it-economics.de`)'"
        - "traefik.http.routers.roominfo-service.entrypoints: 'websecure'"
        - "traefik.http.routers.roominfo-service.tls: 'true'"
        - "traefik.http.routers.roominfo-service.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.roominfo-service.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.roominfo-service.tls.domains[0].sans: '*.it-economics.de'"
      networks:
        - "backbone"

  portainer_stack:
    portainer:
      name: portainer
      image: "cr.portainer.io/portainer/portainer-ee"
      restartPolicy: always
      volumes:
            - '/var/run/docker.sock:/var/run/docker.sock'
            - '{{ docker_home }}/portainer/data:/data'
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.portainer.loadbalancer.server.port: '9000'"
        - "traefik.http.routers.portainer_http.rule: 'Host(`portainer.it-economics.de`)'"
        - "traefik.http.routers.portainer_http.entrypoints: 'web'"
        - "traefik.http.routers.portainer_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.portainer.rule: 'Host(`portainer.it-economics.de`)'"
        - "traefik.http.routers.portainer.entrypoints: 'websecure'"
        - "traefik.http.routers.portainer.tls: 'true'"
        - "traefik.http.routers.portainer.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.portainer.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.portainer.tls.domains[0].sans: '*.it-economics.de'"
      networks:
        - "backbone"
      ports:
        - "9000:9000"
        - "8000:8000"

  passcard_stack:
    passcard:
      name: passcard
      image: "{{ docker_registry }}iteconomics/passcard:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/passcard/data:/var/www/html/storage"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.passcard.loadbalancer.server.port: '80'"
        - "traefik.http.routers.passcard_http.rule: 'Host(`passcard.it-economics.de`)'"
        - "traefik.http.routers.passcard_http.entrypoints: 'web'"
        - "traefik.http.routers.passcard_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.passcard.rule: 'Host(`passcard.it-economics.de`)'"
        - "traefik.http.routers.passcard.entrypoints: 'websecure'"
        - "traefik.http.routers.passcard.tls: 'true'"
        - "traefik.http.routers.passcard.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.passcard.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.passcard.tls.domains[0].sans: '*.it-economics.de'"
      networks:
        - "backbone"

  memorysourceexport_stack:
    memorysourceexport:
      name: memorysourceexport
      image: "{{ docker_registry }}iteconomics/memorysourceexport:latest"
      restartPolicy: always
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.memory.loadbalancer.server.port: '80'"
        - "traefik.http.routers.memory_http.rule: 'Host(`memory.it-economics.de`)'"
        - "traefik.http.routers.memory_http.entrypoints: 'web'"
        - "traefik.http.routers.memory_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.memory.rule: 'Host(`memory.it-economics.de`)'"
        - "traefik.http.routers.memory.entrypoints: 'websecure'"
        - "traefik.http.routers.memory.tls: 'true'"
        - "traefik.http.routers.memory.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.memory.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.memory.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        LDAP_BindDN: "{{ ldap_directory_user }}"
        AUTH_USERS_JSON: "{{ memorysourceexport.AUTH_USERS_JSON }}"
        LDAP_Host: "{{ ldap_url }}"
        LDAP_BASE_DN: "{{ ldap_base_dn }}"
        LDAP_BindPassword: "{{ ldap_directory_pass }}"
      networks:
        - "backbone"

  limesurvey_stack:
    limesurvey:
      name: limesurvey
      image:  "{{ docker_registry }}iteconomics/limesurvey:latest"
      restartPolicy: always
      volumes:
        - "{{ docker_home }}/survey/data/admin_theme:/var/www/html/upload/admintheme/iteconomics"
        - "{{ docker_home }}/survey/data/template:/var/www/html/upload/themes/survey/iteconomics"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.survey.loadbalancer.server.port: '80'"
        - "traefik.http.routers.survey_http.rule: 'Host(`survey.it-economics.de`)'"
        - "traefik.http.routers.survey_http.entrypoints: 'web'"
        - "traefik.http.routers.survey_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.survey.rule: 'Host(`survey.it-economics.de`)'"
        - "traefik.http.routers.survey.entrypoints: 'websecure'"
        - "traefik.http.routers.survey.tls: 'true'"
        - "traefik.http.routers.survey.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.survey.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.survey.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        DB_HOST: "{{ limesurvey.DB_HOST }}"
        DB_NAME: "{{ limesurvey.DB_NAME }}"
        DB_USER: "{{ limesurvey.DB_USER }}"
        DB_PASS: "{{ limesurvey.DB_PASS }}"
        LIMESURVEY_TITLE: "{{ limesurvey.LIMESURVEY_TITLE }}"
        LIMESURVEY_ADMIN: "{{ limesurvey.LIMESURVEY_ADMIN }}"
        LIMESURVEY_ADMIN_PASS: "{{ limesurvey.LIMESURVEY_ADMIN_PASS }}"
        LIMESURVEY_ADMIN_NAME: "{{ limesurvey.LIMESURVEY_ADMIN_NAME }}"
        LIMESURVEY_ADMIN_MAIL: "{{ limesurvey.LIMESURVEY_ADMIN_MAIL }}"
        LIMESURVEY_DEFAULT_LANG: "{{ limesurvey.LIMESURVEY_DEFAULT_LANG }}"
        LIMESURVEY_SHOW_SCRIPT_NAME: "{{ limesurvey.LIMESURVEY_SHOW_SCRIPT_NAME }}"
        LDAP_SERVER: "{{ limesurvey.LDAP_SERVER }}"
        LDAP_PORT: "{{ limesurvey.LDAP_PORT }}"
        LDAP_TLS: "{{ limesurvey.LDAP_TLS }}"
        LDAP_ALLOW_CREATION_TO_LOGGEDIN: "{{ limesurvey.LDAP_ALLOW_CREATION_TO_LOGGEDIN }}"
        LDAP_GROUP_NAME: "{{ limesurvey.LDAP_GROUP_NAME }}"
        LDAP_USER_PREFIX: "{{ limesurvey.LDAP_USER_PREFIX }}"
        LDAP_USER_SUFFIX: "{{ limesurvey.LDAP_USER_SUFFIX }}"
        LDAP_USER_SEARCH_BASE: "{{ limesurvey.LDAP_USER_SEARCH_BASE }}"
        LDAP_GROUP_SEARCH_BASE: "{{ limesurvey.LDAP_GROUP_SEARCH_BASE }}"
        LDAP_BIND_DN: "{{ limesurvey.LDAP_BIND_DN }}"
        LDAP_BIND_PASS: "{{ limesurvey.LDAP_BIND_PASS }}"
        LIMESURVEY_DEBUG: "{{ limesurvey.LIMESURVEY_DEBUG }}"
        ADMIN_THEME_NAME: "{{ limesurvey.ADMIN_THEME_NAME }}"
        DEFAULT_TEMPLATE: "{{ limesurvey.DEFAULT_TEMPLATE }}"
      networks:
        - "backbone"
        - "database"

  dmarc_stack:
    ###
    ## The directory `{{ docker_home }}/dmarc/elc` has to be owned by 1000:0 (uid:gid)
    ##
    ## THIS PERMISSION CHANGE HAS TO BE DONE MANUALLY
    ###
    searchdb:
      name: "dmarc_searchdb"
      image: "library/elasticsearch:{{ dmarc_elc_version }}"
      labels:
        - "traefik.enable: 'false'"
      restartPolicy: "always"
      volumes:
        - "{{ docker_home }}/dmarc/elc:/usr/share/elasticsearch/data/"
      environment:
        cluster.name:          "parsedmarc"
        discovery.type:        "single-node"
        bootstrap.memory_lock: "true"
        ES_JAVA_OPTS:          "-Xms512m -Xmx512m -Dlog4j2.formatMsgNoLookups=true"
      networks:
        - "database"
    analyzer:
      name: "dmarc_analyzer"
      restartPolicy: "always"
      networks:
        - "database"
      labels:
        - "traefik.enable: 'false'"
      image: "devopsansiblede/parsedmarc:latest"
      environment:
        IMAP_HOST:        "outlook.office365.com"
        IMAP_USER:        "forensics@it-economics.de"
        IMAP_PASSWORD:    "{{ dmarc_mail_pw }}"
        ELC_HOST:         "http://dmarc_searchdb"
        GEOIP_ACCOUNTID:  "{{ dmarc_geoip_accid }}"
        GEOIP_LICENSEKEY: "{{ dmarc_geoip_license }}"
        GEOIP_EDITIONIDS: "GeoLite2-ASN GeoLite2-City GeoLite2-Country"
    kibana:
      name: "dmarc_web"
      restartPolicy: "always"
      image: "library/kibana:{{ dmarc_elc_version }}"
      environment:
        SERVER_NAME: "dmarc.muc.it-economics.de"
        SERVER_HOST: "0.0.0.0"
        ELASTICSEARCH_HOSTS: "http://dmarc_searchdb:9200"
        XPACK_MONITORING_UI_CONTAINER_ELASTICSEARCH_ENABLE: "true"
        SERVER_DEFAULTROUTE: "/app/dashboards#/view/269ba470-2871-11e8-b8b2-15742da3055c"
      networks:
        - "backbone"
        - "database"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.dmarc.loadbalancer.server.port: '5601'"
        - "traefik.http.middlewares.dmarcauth.basicAuth.users: '{{ dmarc_basicauth }}'"
        - "traefik.http.routers.dmarc_http.rule: 'Host(`forensic.it-economics.de`)'"
        - "traefik.http.routers.dmarc_http.entrypoints: 'web'"
        - "traefik.http.routers.dmarc_http.middlewares: 'forcehttps@file, dmarcauth@docker'"
        - "traefik.http.routers.dmarc.rule: 'Host(`forensic.it-economics.de`)'"
        - "traefik.http.routers.dmarc.entrypoints: 'websecure'"
        - "traefik.http.routers.dmarc.middlewares: 'dmarcauth@docker'"
        - "traefik.http.routers.dmarc.tls: 'true'"
        - "traefik.http.routers.dmarc.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.dmarc.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.dmarc.tls.domains[0].sans: '*.it-economics.de'"

  personio-backup_stack:
    personio-backup:
      name: "personio-backup"
      image: "docker.it-economics.de/proxy/iteconomics/personio-backup"
      command: "--spring.profiles.active=downloadOnStart"
      restartPolicy: "always"
      volumes:
        - "{{ docker_home }}/personio-backup/data:/data/"
      labels:
        - "traefik.enable: false"
      environment:
        PERSONIO.BACKUP.BACKUPPATH: '/data/'
        PERSONIO.BACKUP.PERSONIOUSERNAME: 'personio-backup@it-economics.de'
        PERSONIO.BACKUP.PERSONIOPASSWORD: "{{ personiobackup.PERSONIOPASSWORD }}"
        PERSONIO.BACKUP.PERSONIOBASEURL: 'https://it-economics.personio.de'
        PERSONIO.BACKUP.BACKUPSTATUSMAILRECEIVER: 'personal@it-economics.de'
        PERSONIO.BACKUP.CRON: '0 * * * *'
        PERSONIO.BACKUP.MAIL.SENDHOST: 'smtp.office365.com'
        PERSONIO.BACKUP.MAIL.RECEIVEHOST: 'outlook.office365.com'
        PERSONIO.BACKUP.MAIL.USERNAME: 'personio-backup@it-economics.de'
        PERSONIO.BACKUP.MAIL.PASSWORD: "{{ personiobackup.PASSWORD }}"
        PERSONIO.BACKUP.MAIL.SENDPORT: '587'
        PERSONIO.BACKUP.MAIL.RECEIVEPORT: '993'
      networks:
        - "backbone"
      logging:
        driver: "awslogs"
        options:
          awslogs-region: "eu-central-1"
          awslogs-group: "docker"
          awslogs-stream: "personiobackup"

  # Application that allows to filter events of Personio calendar
  # by users of the company – e.g. vacation, time off or trainings.
  personio_caltrans_stack:
    caltrans:
      name: 'caltrans'
      image:  "{{ docker_registry }}iteconomics/apache:latest"
      restartPolicy: "always"
      volumes:
        - "{{ docker_home }}/caltrans/data/:/var/www/html/"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.caltrans.loadbalancer.server.port: '80'"
        - "traefik.http.routers.survey_http.rule: 'Host(`personio-caltrans.it-economics.de`)'"
        - "traefik.http.routers.survey_http.entrypoints: 'web'"
        - "traefik.http.routers.survey_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.caltrans.rule: 'Host(`personio-caltrans.it-economics.de`)'"
        - "traefik.http.routers.caltrans.entrypoints: 'websecure'"
        - "traefik.http.routers.caltrans.tls: 'true'"
        - "traefik.http.routers.caltrans.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.caltrans.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.caltrans.tls.domains[0].sans: '*.it-economics.de'"
      environment:
        TIME_OFF_ICAL: "https://it-economics.personio.de/calendar/ical-links/5132469/YEbvEb8kR2jDcYDKwvDNs4Y3FDQN4B3k3jyWAKzpEd4pSkTL0wCdXCNBPThDPUHB5P2xbyyAhEb7Cqq2JVI29s5PAWovnEvopNEEJLOZQAULvbU8dSSEdZ4bGv2hsoSP/5597a68d-d15d-41e0-bcde-a5099cc4b43c.ics"
        TIME_OFF_LOOKUP_ATTRIBUTE: "cn"
        TIME_OFF_EVENT_NAME_REGEX: "^\\s*(\\[(.*?)\\]\\s*(.*?))\\s*$$"
        TIME_OFF_EVENT_GROUP_NAME_CALENDAR_GROUPNO: "2"
        TIME_OFF_EVENT_GROUP_NAME_EVENT_GROUPNO: "3"
        LDAP_CONNECTION_STRING: "{{ ldap_url }}"
        LDAP_BASE_DN: "dc=it-economics,dc=de"
        LDAP_USER_FORMAT: "uid=%s,ou=people"
        LDAP_GROUP_FORMAT: "cn=%s,ou=groups"
        LDAP_USER_OBJECT_CLASS: "(objectclass=inetOrgPerson)"
        LDAP_GROUP_OBJECT_CLASS: "(objectclass=groupOfNames)"
        LDAP_BIND_DN: "{{ ldap_directory_user }}"
        LDAP_BIND_PW: "{{ ldap_directory_pass }}"
        LDAP_GROUP_MEMBER_ATTRIBUTE: "member"
        REQUEST_BASE_PATH: "/"
        REQUEST_KEY: "vVDKrIsfsex/v8rMnS6OHr3Vp4aaMXITK"
      networks:
        - "backbone"

  # SeatSurfing – application to book a seat for an office
  seatsurfing_stack:
    server:
      name: "seatsurfing"
      image: "{{ docker_registry }}seatsurfing/backend:latest"
      restartPolicy: "always"
      environment:
        DEV: 1
        POSTGRES_URL: 'postgres://{{ seatsurfing_credentials.db.user }}:{{ seatsurfing_credentials.db.pass }}@seatsurfing_db/seatsurfing?sslmode=disable'
        JWT_SIGNING_KEY: '{{ seatsurfing_credentials.jwt }}'
        PUBLIC_URL: 'https://seat.it-economics.de'
        FRONTEND_URL: 'https://seat.it-economics.de'
        PUBLIC_LISTEN_ADDR: '0.0.0.0:8080'
        SMTP_HOST: '{{ seatsurfing_credentials.smtp.host }}'
        SMTP_PORT: '{{ seatsurfing_credentials.smtp.port }}'
        SMTP_AUTH: 1
        SMTP_AUTH_USER: '{{ seatsurfing_credentials.smtp.user }}'
        SMTP_AUTH_PASS: '{{ seatsurfing_credentials.smtp.pass }}'
        SMTP_SENDER_ADDRESS: 'support@it-economics.de'
        INIT_ORG_NAME: 'it-economics GmbH'
        INIT_ORG_DOMAIN: 'it-economics.de'
        INIT_ORG_USER: '{{ seatsurfing_credentials.app.sysuser }}'
        INIT_ORG_PASS: '{{ seatsurfing_credentials.app.syspass }}'
        INIT_ORG_COUNTRY: 'DE'
        APP_URL: 'seatsurfing:///'
      networks:
        - "backbone"
        - "database"
      labels:
        - "traefik.enable: 'true'"
        - "traefik.http.services.seat.loadbalancer.server.port: '8080'"
        - "traefik.http.routers.seat_http.rule: 'Host(`seat.it-economics.de`)'"
        - "traefik.http.routers.seat_http.entrypoints: 'web'"
        - "traefik.http.routers.seat_http.middlewares: 'forcehttps@file'"
        - "traefik.http.routers.seat.rule: 'Host(`seat.it-economics.de`)'"
        - "traefik.http.routers.seat.entrypoints: 'websecure'"
        - "traefik.http.routers.seat.tls: 'true'"
        - "traefik.http.routers.seat.tls.certresolver: 'letsencrypt'"
        - "traefik.http.routers.seat.tls.domains[0].main: 'it-economics.de'"
        - "traefik.http.routers.seat.tls.domains[0].sans: '*.it-economics.de'"

    db:
      name: "seatsurfing_db"
      image: "{{ docker_registry }}library/postgres:12"
      restartPolicy: "always"
      volumes:
        - "{{ docker_home }}/seatsurfing/database/data:/var/lib/postgresql/data"
      environment:
        POSTGRES_PASSWORD: 'sdafdfsdDFGDFggf35546gGfffdflasks'
        POSTGRES_USER:     'seatsurfing'
        POSTGRES_DB:       'seatsurfing'
      labels:
        - "traefik.enable: 'false'"
      networks:
        - "database"

...
